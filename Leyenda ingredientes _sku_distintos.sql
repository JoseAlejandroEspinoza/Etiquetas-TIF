SELECT TOP 1 isnull(PCJ.Peso,0) as PesoCaja,isnull(PBL.Peso,0) as PesoBolsa,PCJ.Peso + PBL.Peso as Tara,case when Substring(a.Nombre,0,3)='S-' then 'INGREDIENTES: Agua y mezcla de sal, almidón modificado , fosfatos, fibra vegetal , conservadores , gomas y enzimas.' when a.ArticuloId = 'V031' then 'INGREDIENTES: Agua y mezcla de sal, almidón modificado , fosfatos, fibra vegetal , conservadores , gomas y enzimas.' else '' end as Leyenda,p.ProduccionId,p.FechaProduccion as FechaProduccion,l.Nombre as Lote,p.PesoNeto as Peso,a.Nombre,p.CodigoEtiqueta as Etiqueta,c.FechaCaducidad as FechaCaducidad,c.CantidadBolsas * c.PiezaBolsa as Piezas,CASE WHEN CHARINDEX('RETT',p.CodigoEtiqueta) > 0 THEN Canales.FechaSacrificio ELSE MAX(pCanal.FechaProduccion) END as FechaSacrificio,p.Articulo as ArticuloId,case when Substring(a.Nombre,0,3)='G-' then DATEADD(DAY,30,p.FechaProduccion) else DATEADD(DAY,365,p.FechaProduccion)  end as FechaCaducidadFC,DATEADD(DAY,30,p.FechaProduccion) as FechaCaducidadFresco,DATEADD(DAY,365,p.FechaProduccion) as FechaCaducidadCongelado FROM TIF_Meat.dbo.Produccion p inner join TIF_Meat.dbo.lote l on l.LoteId=p.LoteId inner join TIF_CommerciaNet.dbo.Articulo a on a.ArticuloId=p.Articulo inner join TIF_Meat.dbo.Caja c on c.ProduccionId=p.ProduccionId   left JOIN (SELECT CT.ProduccionId, CT.PesO FROM TIF_Meat.dbo.CajaTara AS CT    INNER JOIN TIF_Meat.dbo.Empaque AS emp ON CT.EmpaqueId = EMP.EmpaqueId AND EMP.TipoEmpaqueId = 1) AS PCJ on PCJ.ProduccionId = p.ProduccionId    left JOIN (SELECT CT.ProduccionId, CT.PesO FROM TIF_Meat.dbo.CajaTara AS CT INNER JOIN TIF_Meat.dbo.Empaque AS emp ON CT.EmpaqueId = EMP.EmpaqueId AND EMP.TipoEmpaqueId = 2) AS PBL on PBL.ProduccionId = p.ProduccionId    left join TIF_Meat.dbo.ProduccionLogistica pl on pl.SolicitudProduccionId=l.loteId    left join TIF_Meat.dbo.Produccion pCanal on pCanal.ProduccionId=pl.ProduccionId    LEFT JOIN (	SELECT 	plCajRet.SolicitudProduccionId as SolicitudProduccionId, 	ISNULL(max(pCan.FechaProduccion),	ISNULL(max(pCaj.FechaProduccion),	max(pCajRet.FechaProduccion))) as FechaSacrificio    FROM TIF_Meat.dbo.ProduccionLogistica plCajRet    INNER JOIN TIF_Meat.dbo.Produccion pCajRet WITH (NOLOCK) on pCajRet.ProduccionId = plCajRet.ProduccionId  INNER JOIN TIF_Meat.dbo.Lote lCajDes WITH (NOLOCK) on lCajDes.LoteId = pCajRet.LoteId  LEFT JOIN TIF_Meat.dbo.ProduccionLogistica plDes WITH (NOLOCK) on plDes.SolicitudProduccionId = lCajDes.LoteId 	 LEFT JOIN TIF_Meat.dbo.Produccion pCaj WITH (NOLOCK) on pCaj.ProduccionId = plDes.ProduccionId LEFT JOIN TIF_Meat.dbo.ProduccionLogistica plCan WITH (NOLOCK) on plCan.SolicitudProduccionId = pCaj.LoteId LEFT JOIN TIF_Meat.dbo.Produccion pCan WITH (NOLOCK) on pCan.ProduccionId = plCan.ProduccionId 	 WHERE lCajDes.TipoLoteId > 3 GROUP BY plCajRet.SolicitudProduccionId) as Canales on Canales.SolicitudProduccionId = l.LoteId WHERE p.produccionid=CAST(@MovimientoId as int)  GROUP BY PCJ.Peso, PBL.Peso,p.ProduccionId,p.FechaProduccion,l.Nombre,p.PesoNeto,a.Nombre,p.CodigoEtiqueta,c.FechaCaducidad,c.CantidadBolsas,c.PiezaBolsa,p.Articulo,Canales.FechaSacrificio 
